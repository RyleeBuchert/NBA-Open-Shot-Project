---
author: "Rylee Buchert"
date: '2022-08-03'
output:
  html_document:
    code_folding: show
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## NBA Open Shot Project

### Introductionfff

Predicted stats provided analysts a way to gauge player performance based on events that were more likely .

The rise of "three true outcomes" baseball 


Any offensive scheme has the goal of generating shots with a high percentage of scoring. 

The goal of this project is to isolate 'open' shots where a player is shooting without a defender immediately nearby. This metric can help when analyzing the ability of offenses go produce high-percentage shots and the strengh of defenses in preventing easy looks. Moreover, 

Unfortunately, there is not a wide breadth of public data available to determine what shots have a contesting defender. The NBA uses an array of cameras and tracking software, known as SportsVU, to record game data, but this information is not generally accessible to the public. The good news is that one season's game tracking data is posted online, convinently posted on [Kaggle](https://www.kaggle.com/datasets/dansbecker/nba-shot-logs).

This dataset contains the records of over 100,000 shots taken during the 2014-15 NBA season, including information about where the shot was taken, game time, and who was the closest defender. Most importantly, each shot has a measure of how far the closest the closest defender was away from the shooter, providing a way to quantify if each shot had a contesting defender.

### What Counts as an "Open" Shot



###

TTT

Load tidyverse and the dataset

```{r message=FALSE}
library(tidyverse)
library(modelr)
library(ggplot2)
shot_data <- read_csv('shot_data2.csv')

```

Add python here for modifying the dataset

```{r python}

```

Regression for wingspan

```{r predicting-wingspan}
# Get rid of unneeded cols and 
wingspan_data <- shot_data %>%
  select(-game_clock, -shot_clock, -dribbles, -touch_time)

# Create regression dataset of data with wingspan available
regression_data <- wingspan_data %>%
  filter(!is.na(closest_def_wingspan))

# Create dataset of 'na' values
na_data <- wingspan_data %>%
  filter(is.na(closest_def_wingspan))

print(nrow(regression_data) / nrow(shot_data))

# Run regression and predict 'na' wingspan values
wingspan_reg <- lm(closest_def_wingspan~closest_def_height, data=regression_data)
na_data <- add_predictions(na_data, wingspan_reg, var="closest_def_wingspan", type=NULL)
na_data$closest_def_wingspan <- round(na_data$closest_def_wingspan, digit=2)

# Combine datasets
wingspan_data <- rbind(regression_data, na_data)

# Convert defender distance to inches
wingspan_data$closest_def_distance_in <- 12 * wingspan_data$closest_defender_distance

# Add team codes from matchup
wingspan_data <- wingspan_data %>%
  mutate(team_name = if_else(nchar(matchup)==24, 
                            if_else(location=="H", 
                                    substr(matchup,22,24), 
                                    substr(matchup,16,18)), 
                            if_else(location=="H", 
                                    substr(matchup,16,18), 
                                    substr(matchup,24,26))),
         opp_team_name = if_else(nchar(matchup)==24, 
                            if_else(location=="H", 
                                    substr(matchup,16,18), 
                                    substr(matchup,22,24)), 
                            if_else(location=="H", 
                                    substr(matchup,24,26), 
                                    substr(matchup,16,18)))) %>%
  relocate(team_name, .after=location) %>%
  relocate(opp_team_name, .after=team_name)

```

Label open shots

```{r label-shots}
# Add open shot based on closest defender wingspan and distance
shot_data <- wingspan_data %>%
  mutate(open_shot = ifelse(closest_def_distance_in > (closest_def_wingspan/2), 1, 0)) %>%
  filter(!is.na(open_shot))
```


Describe open shot stat

```{r}
# Drop missing values and get counts for open/contested shot
shot_data %>% 
  drop_na() %>%
  group_by(open_shot) %>% 
  summarise(count = n(), pct = n()/nrow(shot_data)*100)
```

Add BBref game id for boxscore data

```{r}

# Add team codes from matchup and for BBRef data
shot_data <- shot_data %>%
  mutate(home_team_short = if_else(location=="H", substr(matchup, 16, 18), substr(matchup, 22, 24)),
         away_team_short = if_else(location=="H", substr(matchup, 24, 26), substr(matchup, 16, 18))) %>%
  mutate(bbr_game_id = home_team_short) %>%
  mutate(bbr_game_id = replace(bbr_game_id, bbr_game_id == 'BKN', 'BRK')) %>%
  mutate(bbr_game_id = replace(bbr_game_id, bbr_game_id == 'PHX', 'PHO')) %>%
  mutate(bbr_game_id = replace(bbr_game_id, bbr_game_id == 'CHA', 'CHO')) %>%
  mutate(bbr_team_id = team_name) %>%
  mutate(bbr_team_id = replace(bbr_team_id, bbr_team_id == 'NOP', 'NOH')) %>%
  mutate(bbr_team_id = replace(bbr_team_id, bbr_team_id == 'BKN', 'NJN')) %>%
  mutate(bbr_team_id = replace(bbr_team_id, bbr_team_id == 'PHX', 'PHO')) %>%
  relocate(bbr_team_id, .after=team_name) %>%
  mutate(bbr_opp_team_id = opp_team_name) %>%
  mutate(bbr_opp_team_id = replace(bbr_opp_team_id, bbr_opp_team_id == 'NOP', 'NOH')) %>%
  mutate(bbr_opp_team_id = replace(bbr_opp_team_id, bbr_opp_team_id == 'BKN', 'NJN')) %>%
  mutate(bbr_opp_team_id = replace(bbr_opp_team_id, bbr_opp_team_id == 'PHX', 'PHO')) %>%
  relocate(bbr_opp_team_id, .after=opp_team_name)

# Add BBRef game id
month_convert = c(
  "JAN"="01",
  "FEB"="02",
  "MAR"="03",
  "OCT"="10",
  "NOV"="11",
  "DEC"="12"
)

shot_data <- shot_data %>%
  mutate(bbr_game_id = paste(substr(matchup, 9, 12), month_convert[substr(matchup, 0, 3)], substr(matchup, 5, 6), "0", bbr_game_id, sep="")) %>%
  relocate(bbr_game_id, .after=game_id)

```



```{r}
# Get OKC Data
okc_data <- shot_data %>%
  filter(team_name == "OKC")

boxscore_data <- read_csv("2015_games.csv") %>%
  select(game_id, opp_team_id, fg, fga) %>%
  rename(fga_total = fga, fg_total = fg)

```



```{r}

okc_summary <- okc_data %>%
  group_by(bbr_game_id, bbr_opp_team_id) %>%
  summarise(
    shots_made = sum(fgm),
    shots_attempted = n(),
    fg_pct = shots_made/shots_attempted,
    open_shots = sum(open_shot),
    open_shot_pct = open_shots/shots_attempted
  ) %>%
  arrange(desc(open_shot_pct)) %>%
  left_join(boxscore_data, by=c('bbr_game_id'='game_id', 'bbr_opp_team_id'='opp_team_id')) %>%
  mutate(predicted_open_shots = open_shots/(shots_attempted/fga_total))

```

```{r}

# Get shot data for all games in dataset
league_offense_summary <- shot_data %>%
  group_by(bbr_team_id, bbr_game_id, bbr_opp_team_id) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    fg_pct = fg / fga,
    open_shots = sum(open_shot),
    open_shot_pct = open_shots / fga
  ) %>%
  left_join(boxscore_data, by=c('bbr_game_id'='game_id', 'bbr_opp_team_id'='opp_team_id')) %>%
  mutate(pred_open_shots = open_shots/(fga/fga_total))

```

```{r}

# Highest open shot percentage
league_offense_summary %>%
  group_by(bbr_team_id) %>%
  summarise(
    open_shot_pct = mean(open_shot_pct)
  ) %>%
  arrange(desc(open_shot_pct))

```

```{r}

# Most predicted open shots per game
league_offense_summary %>%
  group_by(bbr_team_id) %>%
  summarise(
    open_shots_pg = mean(pred_open_shots)
  ) %>%
  arrange(desc(open_shots_pg))

```

```{r}

# Get defensive summary for all games
league_defense_summary <- shot_data %>%
  group_by(bbr_opp_team_id, bbr_game_id, bbr_team_id) %>%
  summarise(
    opp_fg = sum(fgm),
    opp_fga = n(),
    opp_fg_pct = opp_fg / opp_fga,
    opp_open_shots = sum(open_shot),
    opp_open_shot_pct = opp_open_shots / opp_fga
  ) %>%
  left_join(boxscore_data, by=c('bbr_game_id'='game_id', 'bbr_opp_team_id'='opp_team_id')) %>%
  mutate(pred_opp_open_shots = opp_open_shots/(opp_fga/fga_total)) %>%
  rename(team = bbr_opp_team_id, opp_team = bbr_team_id)
  
```
```{r}

# Get defenses with the fewest percent of open shots allowed
league_defense_summary %>%
  group_by(team) %>%
  summarise(
    opp_open_shot_pct = mean(opp_open_shot_pct)
  ) %>%
  arrange(opp_open_shot_pct)


```

```{r}

# Get defenses with the fewest open shots allowed per game
league_defense_summary %>%
  group_by(team) %>%
  summarise(
    opp_open_shot_pg = mean(pred_opp_open_shots)
  ) %>%
  arrange(opp_open_shot_pg)

```
```{r}

# Get open shots/percentages for individual players
shooter_summary <- shot_data %>%
  group_by(player_id, player_name) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    fg_pct = fg / fga,
    open_shots = sum(open_shot),
    open_shot_pct = open_shots / fga
  ) %>%
  arrange(desc(open_shots))


```

```{r}

# Best shooters when uncontested
shot_data %>%
  filter(open_shot == 1) %>%
  group_by(player_id, player_name) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    open_fg_pct = fg / fga
  ) %>%
  filter(fga >= 50) %>%
  arrange(desc(open_fg_pct))

```


```{r}

# Best shooters when contested
shot_data %>%
  filter(open_shot == 0) %>%
  group_by(player_id, player_name) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    open_fg_pct = fg / fga
  ) %>%
  filter(fga >= 50) %>%
  arrange(desc(open_fg_pct))

```
```{r}

```