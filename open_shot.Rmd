---
title: "NBA Open Shot Project"
author: "Rylee Buchert"
date: '2022-08-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

The MLB has seen a considerable rise in the so-called "three true outcomes" due in large part to modern analytics. The heavy focus on advanced statistical metrics such as barrels, launch angle, and spin rate have led to a proliferation in home runs and strikeouts across the league. These new methods of characterizing the game provide analysts a way to evaluate players based on attributes likely to produce good results without relying solely on outcome-based statistics. 

I have always been intrigued by the potential application of this idea in NBA stats. Under current practices, every event is treated equal in the scorebook. A rebound with no defenders nearby is weighed the same as a contested board. This beautiful pass by Josh Giddey to find a wide open Tre Mann is valued the same as KD handing Kyrie the ball before an unbelievable contested 3.

<center>
![](img/giddey_assist.gif){width=45%} ![](img/kyrie_3.gif){width=45%}
</center>

&nbsp;

Similar to how barrels/launch angle provides MLB analysts the ability to determine how likely it is for contact to turn into a hit, I hope to develop a metric to track which events translate into scoring with high probability. The principal idea behind this project is to develop some measure of 'openness' in basketball. Being able to differentiate when players are open provides a way to evaluate if a given shot/assist is more likely to result in a basket or how difficult it is to get a rebound.

I believe this concept has the most value in finding the best passers and rebounders in the league, as you can determine who finds the most open players in assists and comes away with the most contested rebounds. Moreover, isolating open shots gives a way to evaluate which teams/offensive schemes produce the most uncontested looks and the strength of defenses in preventing easy looks. Unfortunately, there is not a wide breadth of public data available for answering these questions. Although all NBA teams maintain a database of game tracking information through the SportsVU system, this data is not generally accessible to the public. The good news is that one season's game tracking data is posted online, conveniently available on [Kaggle](https://www.kaggle.com/datasets/dansbecker/nba-shot-logs).

This dataset contains the records of over 100,000 shots taken during the 2014-15 NBA season, including information about where the shot was taken, game time, and who was the closest defender. Most importantly, each shot has a measure of how far the closest the closest defender was away from the shooter, providing a way to quantify if each shot had a contesting defender. Although there is no way to analyze assists/rebounds with this dataset, looking at shots still produces some interesting results and provides a good starting point for investigating this concept.

### What Qualifies as an "Open" Shot

Although the concept of an open look makes sense abstractly, it is harder to quantitatively define for data labeling. Ideally, this would include every shot where the shooter is out of reach of the nearest defender. Yet, this idea can vary considerably depending on the defender and court positioning. This makes it sub-optimal to determine a set "circle", say 3~5 feet around a shooter, that defines their open shot zone.

Instead, I decided to label these shots based on the wingspan of the closest defender. A defender's wingspan allows me to roughly express an 'arm length' away, which I define as the distance required for an uncontested look. According to this rule, every record where a shooter is more than half the closest defender's arm length away is an open shot, and the rest are contested. Although this definition is not perfect, it is a good kickoff point for investigating this idea with the data publicly available.

### Obtaining the Data

The first step is to load all of the required R packages into the environment. For this project, I utilized the tidyverse, modelr, and ggplot2 R packages.

```{r load-data-packages, message=FALSE}
library(tidyverse)
library(modelr)
library(ggplot2)
```

Player wingspan data is not as readily available online as I initially thought it would be. I was only able to find one [website](https://www.nbasavant.com/) which contained wingspan data for the player IDs included in the dataset. Using Python and the BeautifulSoup package, I wrote a quick web scraping function to return the wingspan for a player when given their ID.

```{python add-wingspan, error=TRUE, include=TRUE, eval=FALSE}

# Required packages
import requests
from bs4 import BeautifulSoup
import pandas as pd

# Function to return wingspan from NBAsavant.com
def get_wingspan(player_id):
    # Scrape html from url
    url = f"http://nbasavant.com/player.php?player_id={player_id}"
    soup = BeautifulSoup(requests.get(url).content, 'html5lib')
    
    # Extract and return wingspan from data
    try:
        player_data = soup.find_all("div", {"id": "boxes"})
        player_text = player_data[0].find("br").next
        wingspan = float(player_text.split('Wingspan: ', 1)[1][:5])
        return(wingspan)
    except:
        return('NA')

# Load shot dataset and apply scraping function
shot_data = pd.read_csv('shot_data.csv')
shot_data['closest_def_wingspan'] = shot_data.apply(lambda row: get_wingspan(row['closest_defender_id']), axis=1)
shot_data.to_csv('shot_data.csv')

```

Unfortunately, this only returned usable data for some of the players in the shot data.

```{r analyse-shot-data, message=FALSE}

# Load shot data
shot_data <- read_csv('shot_data.csv')

# Count the number of available wingspan rows
print(sum(!is.na(shot_data$closest_def_wingspan)) / nrow(shot_data))

```

Only a little over two-thirds of the records contain wingspan data after scraping. To fill in the remaining data, I decided to make predictions for player wingspans based on their height. Data for player heights are more easily available online and can be used in a regression to predict wingspans with fairly high accuracy. While this method does not give perfect information about each defender's wingspan, the predicted values still provide useful data relative to each defender and allow me to use the entire dataset.

To obtain player heights, I wrote another BeautifulSoup scraping function which scraped height from [NBA's player pages](https://www.nba.com/players). I also collected each player's position in the function for use later in this analysis. This code snippet produces a player information CSV file which then joined with the shot data after creation.

```{python add-height-pos, error=TRUE, include=TRUE, eval=FALSE}

# Function to scrape player's height and position
def get_height_position(player_id):
    # Scrape html from url
    url = f"https://www.nba.com/player/{player_id}"
    soup = BeautifulSoup(requests.get(url).content, 'html5lib')

    # Get height from data
    try:
        height_data = soup.find_all("p", {"class": "PlayerSummary_playerInfoValue__mSfou"})
        height_text = height_data[0].contents[0].split(' ')[0].split("\'")
        height = (int(height_text[0])*12) + int(height_text[1].replace("\"", ""))
    except:
        height = 'NA'

    # Get position from data
    try:
        position_data = soup.find_all("p", {"class": "t11 md:t2"})
        position_text = position_data[0].contents[0].split('|')
        position = position_text[2].strip(" ")
    except:
        position = 'NA'

    return (height, position)

# Load shot data and get all unique player id's 
shot_data = pd.read_csv('shot_data.csv')
shooter_list = shot_data.player_id.unique().tolist()
defender_list = shot_data.closest_defender_id.unique().tolist()
player_df = pd.DataFrame(set(shooter_list + defender_list)).rename(columns={0: 'player_id'})

# Create cols for height/position and save player info dataframe
player_df['height'] = player_df.apply(lambda row: get_height_position(row['player_id'])[0], axis=1)
player_df['position'] = player_df.apply(lambda row: get_height_position(row['player_id'])[1], axis=1)
player_df.to_csv('2015_player_info.csv')

```

Join the player info with the shot data

```{r join-player-data, message=FALSE}

# Add shooter/defender height and position to shot data
player_info <- read_csv('2015_player_info.csv')

shot_data <- shot_data %>%
  left_join(player_info, by=c("closest_defender_id"="player_id")) %>%
  rename(closest_def_height = height,
         closest_def_position = position) %>%
  relocate(closest_defender, .after=player_id) %>%
  relocate(closest_defender_id, .after=closest_defender) %>% 
  relocate(closest_defender_distance, .after=closest_defender_id) %>%
  left_join(player_info, by="player_id") %>%
  rename(player_height = height,
         player_position = position) %>%
  relocate(player_height, .after=player_id) %>%
  relocate(player_position, .after=player_height)

```

With all of the necessary data loaded, we can run a simple linear regression of the available data's defender height on wingspan. Using the regression results, it is easy to make predictions for the unavailable data 

```{r predicting-wingspan}

# Get data where wingspan is available
available_data <- shot_data %>%
  filter(!is.na(closest_def_wingspan))

# Get dataset of 'na' values
na_data <- shot_data %>%
  filter(is.na(closest_def_wingspan))

# Run regression and predict 'na' wingspan values
wingspan_reg <- lm(closest_def_wingspan~closest_def_height, data=available_data)
na_data <- add_predictions(na_data, wingspan_reg, var="closest_def_wingspan", type=NULL)
na_data$closest_def_wingspan <- round(na_data$closest_def_wingspan, digit=2)

# Combine datasets and remove unneeded data
shot_data <- rbind(available_data, na_data)
rm(available_data, na_data)

```

The final step in preparing the dataset is to add some more fields and clean up the data for later analysis. In this chunk, I converted defender distance to inches, added team codes for home/away, dropped unneeded columns, and added a game id that matches Basketball-References's data for joining purposes later in this report.

```{r clean-data}

# Convert defender distance to inches
shot_data$closest_def_distance_in <- 12 * shot_data$closest_defender_distance

# Add team codes from matchup
shot_data <- shot_data %>%
  mutate(team_name = if_else(nchar(matchup)==24, 
                            if_else(location=="H", 
                                    substr(matchup,22,24), 
                                    substr(matchup,16,18)), 
                            if_else(location=="H", 
                                    substr(matchup,16,18), 
                                    substr(matchup,24,26))),
         opp_team_name = if_else(nchar(matchup)==24, 
                            if_else(location=="H", 
                                    substr(matchup,16,18), 
                                    substr(matchup,22,24)), 
                            if_else(location=="H", 
                                    substr(matchup,24,26), 
                                    substr(matchup,16,18)))) %>%
  relocate(team_name, .after=location) %>%
  relocate(opp_team_name, .after=team_name)

# Drop unneeded columns
shot_data <- shot_data %>%
  select(-game_clock, -shot_clock, -dribbles, -touch_time)

# Add team codes from matchup and for BBRef data
shot_data <- shot_data %>%
  mutate(home_team_short = if_else(location=="H", substr(matchup, 16, 18), substr(matchup, 22, 24)),
         away_team_short = if_else(location=="H", substr(matchup, 24, 26), substr(matchup, 16, 18))) %>%
  mutate(bbr_game_id = home_team_short) %>%
  mutate(bbr_game_id = replace(bbr_game_id, bbr_game_id == 'BKN', 'BRK')) %>%
  mutate(bbr_game_id = replace(bbr_game_id, bbr_game_id == 'PHX', 'PHO')) %>%
  mutate(bbr_game_id = replace(bbr_game_id, bbr_game_id == 'CHA', 'CHO')) %>%
  mutate(bbr_team_id = team_name) %>%
  mutate(bbr_team_id = replace(bbr_team_id, bbr_team_id == 'NOP', 'NOH')) %>%
  mutate(bbr_team_id = replace(bbr_team_id, bbr_team_id == 'BKN', 'NJN')) %>%
  mutate(bbr_team_id = replace(bbr_team_id, bbr_team_id == 'PHX', 'PHO')) %>%
  relocate(bbr_team_id, .after=team_name) %>%
  mutate(bbr_opp_team_id = opp_team_name) %>%
  mutate(bbr_opp_team_id = replace(bbr_opp_team_id, bbr_opp_team_id == 'NOP', 'NOH')) %>%
  mutate(bbr_opp_team_id = replace(bbr_opp_team_id, bbr_opp_team_id == 'BKN', 'NJN')) %>%
  mutate(bbr_opp_team_id = replace(bbr_opp_team_id, bbr_opp_team_id == 'PHX', 'PHO')) %>%
  relocate(bbr_opp_team_id, .after=opp_team_name)

# Add BBRef game id
month_convert = c(
  "JAN"="01",
  "FEB"="02",
  "MAR"="03",
  "OCT"="10",
  "NOV"="11",
  "DEC"="12"
)

shot_data <- shot_data %>%
  mutate(bbr_game_id = paste(substr(matchup, 9, 12), month_convert[substr(matchup, 0, 3)], substr(matchup, 5, 6), "0", bbr_game_id, sep="")) %>%
  relocate(bbr_game_id, .after=game_id)

```

With the dataset fully prepared, it is time to add the important column: open_shot. This can be created by mutating the dataset with a dummy variable that takes a value of 1 when a shooter is more than half the wingspan of the closest defender away, and 0 otherwise.

```{r label-shots}

# Add open shot based on closest defender wingspan and distance
shot_data <- shot_data %>%
  mutate(open_shot = ifelse(closest_def_distance_in > (closest_def_wingspan / 2), 1, 0)) %>%
  filter(!is.na(open_shot))

```

### Investigating the Data

The shot dataset now includes over 125,000 individual shots from the 2014-15 season. According to Sports-Reference's [stathead](https://stathead.com/all/), there were just over 200,000 total shots taken during that season, meaning we have roughly 60% of the data available. This sample is more than enough for this report even though we won't have perfect information from that season. 

Looking at the now labelled data, about 46% of shots are contested while 54% are considered open. This is a great split for looking at performance trends for team offenses/defenses and individual players.

```{r summarize-shot-data}

# Get counts for open/contested shot
shot_data %>%
  group_by(open_shot) %>%
  summarise(
    count = n(),
    pct = n()/nrow(shot_data)*100
  )

```

First I'm going to look at team statistics to examine how open shots correlate with offensive/defensive performance. Since the shot data only includes a portion of the total shots from the 2015 season, it's difficult to determine per game stat totals. Using Stathead, I collected the total number of field goals attempted by each team for all games during the season. Knowing the number of shots attempted allows me to normalize any stats created and obtain total stats per game.

```{r get-boxscore-data, message=FALSE}

# Get boxscore data from BBRef
boxscore_data <- read_csv("2015_games.csv") %>%
  select(game_id, opp_team_id, fg, fga) %>%
  rename(fga_total = fga, fg_total = fg)

```

In the following chunk I create a game summary table which includes field goals made/attempted from both the original shot data and the Stathead totals, the number of open shots, and percent of total shots that are uncontested for each game in a team's schedule. The Stathead data allows me to calculate the predicted number of open looks by normalizing shot data to game totals.

```{r offense-summary, message=FALSE}

# Get shot data for all games in dataset
league_offense_summary <- shot_data %>%
  group_by(bbr_team_id, bbr_game_id, bbr_opp_team_id) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    fg_pct = fg / fga,
    open_shots = sum(open_shot),
    open_shot_pct = open_shots / fga
  ) %>%
  left_join(boxscore_data, by=c('bbr_game_id'='game_id', 'bbr_opp_team_id'='opp_team_id')) %>%
  mutate(pred_open_shots = open_shots/(fga/fga_total))

```

Using the summary table I can produce some statistics by team offenses. The following table highlights the teams with the highest number of shots being uncontested

```{r offense-os-pct}

# Highest open shot percentage
league_offense_summary %>%
  group_by(bbr_team_id) %>%
  summarise(
    open_shot_pct = mean(open_shot_pct)
  ) %>%
  arrange(desc(open_shot_pct))

```

Instead of using percentages, we can also compute the teams with the most open looks per game.

```{r offense-os-pg}

# Most predicted open shots per game
league_offense_summary %>%
  group_by(bbr_team_id) %>%
  summarise(
    open_shots_pg = mean(pred_open_shots)
  ) %>%
  arrange(desc(open_shots_pg))

```

These stats are interesting to consider but don't explain much about how open looks contribute to offensive success. Using some more data from Stathead, the following graph shows the relationship between open shot percentage and offensive rating. 

```{r plot-ortg, fig.align='center', message=FALSE}

# Get offensive rating data by team
offensive_rating <- read_csv("2015_team_season.csv") %>%
  select(Tm, eFG, ORtg) %>%
  rename(bbr_team_id = Tm)

# Join ratings with open shot pct by team
os_pct_offense <- league_offense_summary %>%
  group_by(bbr_team_id) %>%
  summarise(
    open_shot_pct = mean(open_shot_pct)
  ) %>%
  arrange(desc(open_shot_pct)) %>%
  left_join(offensive_rating, by="bbr_team_id")

# Plot the results
library(ggrepel)
ggplot(data=os_pct_offense, mapping=aes(x=ORtg, y=open_shot_pct, color=eFG)) + 
  geom_point(size=2) + 
  geom_smooth(method = lm) +  
  geom_text_repel(aes(label=bbr_team_id)) + 
  labs(x = "Points Scored per 100 Possessions", 
       y = "% of Shots Open on Offense",
       color = "eFG%") + 
  scale_color_gradient(low = "blue", high = "red")

```

This graph shows that, generally, teams with a higher percent of open looks score more efficiently. This relationship is not extraordinarily strong though; only 6 of the top 12 teams in terms of open shot percentage rank in the top 12 of offensive rating. Even though team offenses may generate uncontested shots at an efficient rate, that does not translate to ORtg if they can't make the shots. A good example of this is the New York Knicks. Despite ranking 7th in open shot percentage, the Knicks ranked 29th in offensive rating. Their very low field goal rate makes it hard to score despite having many high-percentage shot opportunities.

Similar to team offense, I computed these stats for defenses as well. 

```{r defense-summary, message=FALSE}

# Get defensive summary for all games
league_defense_summary <- shot_data %>%
  group_by(bbr_opp_team_id, bbr_game_id, bbr_team_id) %>%
  summarise(
    opp_fg = sum(fgm),
    opp_fga = n(),
    opp_fg_pct = opp_fg / opp_fga,
    opp_open_shots = sum(open_shot),
    opp_open_shot_pct = opp_open_shots / opp_fga
  ) %>%
  left_join(boxscore_data, by=c('bbr_game_id'='game_id', 'bbr_opp_team_id'='opp_team_id')) %>%
  mutate(pred_opp_open_shots = opp_open_shots/(opp_fga/fga_total)) %>%
  rename(team = bbr_opp_team_id, opp_team = bbr_team_id)
  
```

The following table shows the defenses that allowed the fewest percent of open shots during the season.

```{r defense-os-pct}

# Get defenses with the fewest percent of open shots allowed
league_defense_summary %>%
  group_by(team) %>%
  summarise(
    opp_open_shot_pct = mean(opp_open_shot_pct)
  ) %>%
  arrange(opp_open_shot_pct)

```

And this table shows the defenses who allowed the fewest number of open shots a game.

```{r defense-os-pg}

# Get defenses with the fewest open shots allowed per game
league_defense_summary %>%
  group_by(team) %>%
  summarise(
    opp_open_shot_pg = mean(pred_opp_open_shots)
  ) %>%
  arrange(opp_open_shot_pg)

```

Plotting this data against team defensive rating and opponent eFG%, a stronger relationship is revealed.

```{r plot-drtg, fig.align='center', message=FALSE}

# Get defensive rating for each team
defensive_rating <- read_csv("2015_team_season.csv") %>%
  select(Tm, opp_eFG, DRtg) %>%
  rename(bbr_team_id = Tm)

# Join with opponent open shot percent data
os_pct_defense <- league_defense_summary %>%
  group_by(team) %>%
  summarise(
    opp_open_shot_pct = mean(opp_open_shot_pct)
  ) %>%
  arrange(desc(opp_open_shot_pct)) %>%
  left_join(defensive_rating, by=c("team"="bbr_team_id"))

# Plot the data
ggplot(data=os_pct_defense, mapping=aes(x=DRtg, y=opp_open_shot_pct, color=opp_eFG)) + 
  geom_point(size=2) + 
  geom_smooth(method = lm) +  
  geom_text_repel(aes(label=team)) + 
  labs(x = "Points Allowed per 100 Possessions", 
       y = "% of Shots Open on Defense",
       color = "Opp eFG%") + 
  scale_color_gradient(low = "blue", high = "red")

```

Opposed to the plot from above, open shot percentage allowed is significantly more correlated to defensive rating. 9 of the top 12 open shot percentage defenses ranked in the top 12 of defensive rating. This highlights how defensive structures which prevent easy looks correlate strongly to success in preventing scoring. 




```{r shooting-summary}

# Get open shots/percentages for individual players
shooter_summary <- shot_data %>%
  group_by(player_id, player_name) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    fg_pct = fg / fga,
    open_shots = sum(open_shot),
    open_shot_pct = open_shots / fga
  ) %>%
  arrange(desc(open_shots))


```


```{r shooting-uncontested}

# Best shooters when uncontested
shot_data %>%
  filter(open_shot == 1) %>%
  group_by(player_id, player_name) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    open_fg_pct = fg / fga
  ) %>%
  filter(fga >= 50) %>%
  arrange(desc(open_fg_pct))

```


```{r shooting-contested}

# Best shooters when contested
shot_data %>%
  filter(open_shot == 0) %>%
  group_by(player_id, player_name) %>%
  summarise(
    fg = sum(fgm),
    fga = n(),
    open_fg_pct = fg / fga
  ) %>%
  filter(fga >= 50) %>%
  arrange(desc(open_fg_pct))

```

Add by position
